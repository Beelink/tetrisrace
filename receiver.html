<!DOCTYPE html>
<html> 
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Receiver</title>
        <script src="/socket.io/socket.io.js"></script>
        <style>
            body {
                background-color: lightgray;
            }

            .container {
                width: 800px;
                margin: 16px;
				border: 6px solid black;
				background-color: white;
                border-radius: 32px;
                text-align: center;
                width: calc(100% - 32px);
            }

            canvas {
                margin: 16px;
				border: 6px solid black;
				background-color: white;
                border-radius: 32px;
                width: calc(100% - 36px);
            }

            span {
                font-weight: bold;
                font-family: Helvetica;
                font-size: 5vw;
                display: inline-block;
                margin: 16px;
            }
        </style>
    </head>
    <body> 
        <div class="container">
            <span id="score_value"></span>
            <span id="dificulty_value"></span>
            <span id="complexity_value">ðŸ’š Easy</span>
        </div>
        <canvas id="div_canvas" width="800" height="300"></canvas>
        <script>    
            var socket = io('http://localhost:8080');

            let g = null;
                
            socket.on('send-message', function (data) {
                switch(data['message']) {
                case "left": g.left();
                    break;
                case "right": g.right();
                    break;
                case "up": g.up();
                    break;
                case "down": g.down();
                    break;
                case "restart": restart();
                    break;
                case "complexity": g.toggleComplexity();
                    break;
                }
            });

            function HardBlock(x1, y1, width1, height1, game, targetY) {
                let x = x1;
                let y = y1;
                let width = width1;
                let height = height1;

                this.getWidth = function() {
                    return width;
                }

                this.getHeight = function() {
                    return height;
                }

                this.getX = function() {
                    return x;
                }
            
                this.getY = function() {
                    return y;
                }

                this.draw = function() {
                    x -= game.getDificulty();
                    
                    if(y > targetY) {
                        y--;
                    }
                    if(y < targetY) {
                        y++;
                    }

                    game.getCtx().beginPath();
                    game.getCtx().fillStyle = "rgb(240, 58, 23)";
                    game.getCtx().fillRect(x, y, width, height);
                    game.getCtx().closePath();
                }
            }
    
            function EasyBlock(x1, y1, width1, height1, game) {
                let x = x1;
                let y = y1;
                let width = width1;
                let height = height1;

                this.getWidth = function() {
                    return width;
                }

                this.getHeight = function() {
                    return height;
                }

                this.getX = function() {
                    return x;
                }
            
                this.getY = function() {
                    return y;
                }
    
                this.draw = function() {
                    x -= game.getDificulty();

                    game.getCtx().beginPath();
                    game.getCtx().fillStyle = "rgb(0, 0, 0)";
                    game.getCtx().fillRect(x, y, width, height);
                    game.getCtx().closePath();
                }
            }

            function MainCharacter(game) {
                let x = 0;
                let y = Math.floor(game.getCanvasHeight() / 2);
                let width = 100;
                let height = 50;
                let targetX = x;
                let targetY = y;

                this.getWidth = function() {
                    return width;
                }

                this.getHeight = function() {
                    return height;
                }

                this.getX = function() {
                    return x;
                }

                this.getY = function() {
                    return y;
                }

                this.getTargetY = function() {
                    return targetY;
                }
                
                this.draw = function() {
                    if(x < targetX) {
                        x += 10;
                    }
                    if(x > targetX) {
                        x -= 10;
                    }
                    if(y < targetY) {
                        y += 10;
                    }
                    if(y > targetY) {
                        y -= 10;
                    }

                    game.getCtx().beginPath();
                    game.getCtx().fillStyle = "rgb(22, 198, 12)";;
                    game.getCtx().fillRect(x, y, width, height);
                    game.getCtx().closePath();
                }
    
                this.right = function() {
                    if(targetX + width < game.getCanvasWidth()) {
                        targetX += 50;
                    }
                }
    
                this.left = function() {
                    if(targetX > 0) {
                        targetX += -50;
                    }
                }
    
                this.down = function() {
                    if(targetY + height < game.getCanvasHeight()) {
                        targetY += 50;
                    }
                }
    
                this.up = function() {
                    if(targetY > 0) {
                        targetY += -50;
                    }
                }
            }
    
            function Game(canvas, scoreText, dificultyText, complexityText) {
                let ctx = canvas.getContext("2d");
                let height = canvas.height;
                let width = canvas.width;
                let play = true;
                let easyComplexity = true;
                let blocks = [];
                let score = 0;
                let dificulty = 1;
                let self = this;
                let mainCharacter = null;
                let timer = Date.now();

                this.toggleComplexity = function() {
                    if(easyComplexity) {
                        easyComplexity = false;
                        complexityText.innerHTML = "ðŸ˜¡ Hard";
                    } else {
                        easyComplexity = true;
                        complexityText.innerHTML = "ðŸ’š Easy";
                    }
                    socket.emit('request-message', { message: "back-complexity", value: easyComplexity });
                }

                this.left = function() {
                    mainCharacter.left();
                }

                this.right = function() {
                    mainCharacter.right();
                }

                this.up = function() {
                    mainCharacter.up();
                }

                this.down = function() {
                    mainCharacter.down();
                }

                this.getCtx = function() {
                    return ctx;
                }

                this.getCanvasHeight = function() {
                    return height;
                }

                this.getCanvasWidth = function() {
                    return width;
                }

                this.getDificulty = function() {
                    return dificulty;
                }
    
                let loop = function() {
                    if(play) {
                        ctx.fillStyle = "rgb(255, 255, 255)";
                        ctx.fillRect(0, 0, width, height);
                        mainCharacter.draw();
                        for(let i = 0; i < blocks.length; i++) { 
                            if(blocks[i].getX() + blocks[i].getWidth() < 0) {
                                blocks.splice(i, 1);
                            } else {
                                if(blocks[i].getY() == mainCharacter.getY()) {
                                    if(blocks[i].getX() < mainCharacter.getX() + mainCharacter.getWidth() && blocks[i].getX() + blocks[i].getWidth() > mainCharacter.getX()) {
                                        play = false;
                                    }
                                }
                                blocks[i].draw();
                            }                            
                        }
                        score++;
                        scoreText.innerHTML = "ðŸ’¯ " + score;

                        dificulty += 0.0025;
                        dificultyText.innerHTML = "âš¡ x" + Math.round(dificulty * 100) / 100;

                        if(Date.now() - timer > 5000 * (1 / dificulty)) {
                            timer = Date.now();
                            if(easyComplexity) {
                                createEasyBlock();
                            } else {
                                createHardBlock();
                            }
                        }
                    } else {
                        scoreText.innerHTML = "ðŸ’¥ " + score; 
                                
                        ctx.fillStyle = "rgb(240, 58, 23)";
                        ctx.fillRect(0, 0, width, height);
                    }

                    window.requestAnimationFrame(loop);
                }

                let createEasyBlock = function() {
                    let random = 50 * getRandomInt(1, 6);
                    blocks.push(new EasyBlock(width, random, 100, 50, self));
                }

                let createHardBlock = function() {
                    let random = 50 * getRandomInt(1, 6);
                    blocks.push(new HardBlock(width, random, 100, 50, self, mainCharacter.getTargetY()));
                }

                this.startGame = function() {
                    mainCharacter = new MainCharacter(self);

                    window.requestAnimationFrame(loop);
                }
            }   
    
            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min)) + min;
            }

            function restart() {
                location.reload();
            } 

            window.onload = init();

            function init() {
                g = new Game(document.getElementById("div_canvas"), document.getElementById("score_value"), document.getElementById("dificulty_value"), document.getElementById("complexity_value"));
                g.startGame();
            }
        </script>
    </body>
</html>
