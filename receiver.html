<!DOCTYPE html>
<html> 
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Receiver</title>
        <script src="/socket.io/socket.io.js"></script>
        <style>
            div {
                width: 800px;
                margin: 50px auto;
            }

            #div_canvas {
                border: 5px solid black;
            }

            span {
                font-weight: bold;
                font-family: Helvetica;
                font-size: 32px;
            }

            #dificulty_value {
                float: right;
            }

            #type_difficulty{
                width: 100px;
                height: 50px;
                background: rgb(0, 165, 0);
                border: none;
                font-size: 20px;
                color: white;
                position: absolute;
                left: 50%;
                margin: -25px 0 0 -50px; 
            }
        </style>
    </head>
    <body> 
        <div>
            <span id="score_value"></span>
            <span id="dificulty_value"></span>
            <button id="type_difficulty" onclick="changeTypeDifficulty()">Easy</button>
            <canvas id="div_canvas" width="800" height="300"></canvas>
        </div>
        <script>    
            var socket = io('http://localhost:8080');

            
            var game = new Game();
            var mainCharacter = new MainCharacter();
            var background = new Image();
                // background.src = "img/background.png";
            background.src = "https://raw.githubusercontent.com/Beelink/tetrisrace/master/public/img/background.png";
            var backgroundPattern = game.ctx.createPattern(background, 'repeat');

            var foreground = new Image();
                // foreground.src = "img/foreground.png";
            foreground.src = "https://raw.githubusercontent.com/Beelink/tetrisrace/master/public/img/foreground.png";
            var foregroundPattern = game.ctx.createPattern(foreground, 'repeat'); 
            var position = Math.floor(game.height / 2);
            var blocks = [];
                
            var score = 0;
            var score_value = document.getElementById("score_value");
            var dificulty_value = document.getElementById("dificulty_value");
            var dificulty = 1;    
                
            
            socket.on('send-message', function (data) {
                console.log("done-message = " + data['message']);
                switch(data['message']) {
                case "left": mainCharacter.left();
                    break;
                case "right": mainCharacter.right();
                    break;
                case "up": mainCharacter.up();
                    break;
                case "down": mainCharacter.down();
                    break;
                case "restart": restart();
                    break;
                }
            });
    
            function Block(x, y, width, height, mainY) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = "black"
                this.mainY = mainY;

    
                this.drawBlock = function() {
                    // console.log(this.mainX + " " + this.mainY);
                    game.ctx.beginPath();
                    game.ctx.fillStyle = foregroundPattern;
                    game.ctx.fillRect(this.x, this.y, this.width, this.height);
                    game.ctx.closePath();
                }
    
                this.draw = function() {
                    this.drawBlock.call(this);
                    this.x -= dificulty;
                    if(!game.easy_complexity){
                        if(this.y == this.mainY){
                            return ;
                        }else if(this.y > this.mainY){
                            this.y -= 0.5;
                        }else{
                            this.y += 0.5;
                        }
                    }

                    if(this.x < - this.width) {
                        for(let i = 0; i < blocks.length; i++) {
                            if(blocks[i] == this){
                                game.removeBlock(blocks, i);
                            }
                        }
                    }
                }
            }
    
            function MainCharacter() {
                console.log(game)
                this.x = 0;
                this.y = Math.floor((game.height) / 2);
                this.width = 100;
                this.height = 50;
                this.color = "black"
                this.targetX = this.x;
                this.targetY = this.y;
                
    
                this.drawMainCharacter = function() {
                    if(this.x < this.targetX) {
                        this.x += 10;
                    }
                    if(this.x > this.targetX) {
                        this.x -= 10;
                    }
                    if(this.y < this.targetY) {
                        this.y += 10;
                    }
                    if(this.y > this.targetY) {
                        this.y -= 10;
                    }

                    game.ctx.beginPath();
                    game.ctx.fillStyle = foregroundPattern;
                    game.ctx.fillRect(this.x, this.y, this.width, this.height);
                    game.ctx.closePath();
                    // console.log(this)
                }
                let drawMC = this.drawMainCharacter.bind(this);

                this.draw = function() {
                    // console.log(this)
                    // this.drawMainCharacter.call(this);
                    drawMC();
                }
    
                this.right = function() {
                    if(this.targetX + this.width < game.width) {
                        this.targetX += 50;
                    }
                }
    
                this.left = function() {
                    if(this.targetX > 0) {
                        this.targetX += -50;
                    }
                }
    
                this.down = function() {
                    if(this.targetY + this.height < game.height) {
                        this.targetY += 50;
                    }
                }
    
                this.up = function() {
                    if(this.targetY > 0) {
                        this.targetY += -50;
                    }
                }
            }
    
            function Game(){
                this.canvas = document.getElementById("div_canvas");
                this.ctx = this.canvas.getContext("2d");
                this.height = this.canvas.height;
                this.width = this.canvas.width;
                this.play = true;
                this.easy_complexity = true;
                                
                this.removeBlock = function(items, i){
                    items.splice(i, 1);
                }
        
                // this.addedBlock = function(items, elem){
                //     items.push(elem);
                // }
            
    
                this.animation = function() {
                    // console.log(this);
                    if(this.play) {
                        this.ctx.fillStyle = backgroundPattern;
                        this.ctx.fillRect(0, 0, game.width, game.height);
                        mainCharacter.draw.call(mainCharacter);
                        for(let i = 0; i < blocks.length; i++) { 
                            if(blocks[i].y == mainCharacter.y) {
                                if(blocks[i].x < mainCharacter.x + mainCharacter.width && blocks[i].x + blocks[i].width > mainCharacter.x) {
                                    this.play = false;
                                }
                            }
                            blocks[i].draw.call(blocks[i]);
                        }
                        score++;
                        score_value.innerHTML = "Score: " + score;

                        dificulty += 0.001;
                        dificulty_value.innerHTML = "Speed: x" + Math.round(dificulty * 100) / 100;
                    } else {
                        score_value.innerHTML = "Crash! Total: " + score; 
                                
                        this.ctx.fillStyle = foregroundPattern;
                        this.ctx.fillRect(0, 0, this.width, this.height);
                    }
                    // requestAnimationFrame(this.animation);
                }
                
                this.startGame = function(){
                let animationGame = game.animation.bind(game);
                    // console.log(this);
                    function addedBlock(){
                        let random = 50 * getRandomInt(1, 6);
                        blocks.push(new Block(this.width, random, 100, 50, mainCharacter.y));
                    }

                    function callAnimationGame(){
                        if(!this.play) clearInterval(timeAnimation);
                        animationGame();
                    }
                    let timeId = setInterval(addedBlock.bind(this), 5000);

                    let timeAnimation = setInterval(callAnimationGame.bind(this), 10);
                    // requestAnimationFrame(this.animation.bind(this));
                    // requestAnimationFrame(animationBind)
                
            }
                  
            }   
    
            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min)) + min;
            }

            function restart() {
                location.reload();
            } 

            function changeTypeDifficulty(){
                if(document.getElementById("type_difficulty").innerHTML == "Easy"){
                    game.easy_complexity = false;
                    document.getElementById("type_difficulty").innerHTML = "Hard";
                    document.getElementById("type_difficulty").style.background = "red";
                }else{
                    game.easy_complexity = true;
                    document.getElementById("type_difficulty").innerHTML = "Easy";
                    document.getElementById("type_difficulty").style.background = "green";
                }
            }

            window.onload = () => {
                let random = 50 * getRandomInt(1, 6);
                blocks.push(new Block(game.width, random, 100, 50, mainCharacter.y));

                
                game.startGame();
            }
            
        </script>
    </body>
</html>
