<!DOCTYPE html>
<html> 
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Receiver</title>
        <script src="/socket.io/socket.io.js"></script>
        <style>
            body {
                background-color: lightgray;
            }

            .container {
                width: 800px;
                margin: 16px;
				border: 6px solid black;
				background-color: white;
                border-radius: 32px;
                text-align: center;
                width: calc(100% - 32px);
            }

            canvas {
                margin: 16px;
				border: 6px solid black;
				background-color: white;
                border-radius: 32px;
                width: calc(100% - 36px);
            }

            span {
                font-weight: bold;
                font-family: Helvetica;
                font-size: 5vw;
                display: inline-block;
                margin: 16px;
            }
        </style>
    </head>
    <body> 
        <div class="container">
            <span id="score_value"></span>
            <span id="dificulty_value"></span>
            <span id="complexity_value">ðŸ’š Easy</span>
        </div>
        <canvas id="div_canvas" width="800" height="300"></canvas>
        <script>    
            var socket = io('http://localhost:8080');

            var game = new Game();
            var mainCharacter = new MainCharacter();
            var background = new Image();
                // background.src = "img/background.png";
            background.src = "https://raw.githubusercontent.com/Beelink/tetrisrace/master/public/img/background.png";
            var backgroundPattern = game.ctx.createPattern(background, 'repeat');

            var foreground = new Image();
                // foreground.src = "img/foreground.png";
            foreground.src = "https://raw.githubusercontent.com/Beelink/tetrisrace/master/public/img/foreground.png";
            var foregroundPattern = game.ctx.createPattern(foreground, 'repeat'); 
            var position = Math.floor(game.height / 2);
            var blocks = [];
                
            var score = 0;
            var score_value = document.getElementById("score_value");
            var dificulty_value = document.getElementById("dificulty_value");
            var dificulty = 1;    
                
            
            socket.on('send-message', function (data) {
                switch(data['message']) {
                case "left": mainCharacter.left();
                    break;
                case "right": mainCharacter.right();
                    break;
                case "up": mainCharacter.up();
                    break;
                case "down": mainCharacter.down();
                    break;
                case "restart": restart();
                    break;
                case "complexity": changeTypeDifficulty();
                    break;
                }
            });
    
            function Block(x, y, width, height, mainY) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = "black"
                this.mainY = mainY;
    
                this.drawBlock = function() {
                    game.ctx.beginPath();
                    game.ctx.fillStyle = "rgb(0, 0, 0)";
                    game.ctx.fillRect(this.x, this.y, this.width, this.height);
                    game.ctx.closePath();
                }
    
                this.draw = function() {
                    this.drawBlock.call(this);
                    this.x -= dificulty;
                    if(!game.easy_complexity) {
                        if(this.y == this.mainY) {
                            return ;
                        } else if(this.y > this.mainY) {
                            this.y -= 0.5;
                        }else{
                            this.y += 0.5;
                        }
                    }

                    if(this.x < - this.width) {
                        for(let i = 0; i < blocks.length; i++) {
                            if(blocks[i] == this) {
                                game.removeBlock(blocks, i);
                            }
                        }
                    }
                }
            }
    
            function MainCharacter() {
                this.x = 0;
                this.y = Math.floor((game.height) / 2);
                this.width = 100;
                this.height = 50;
                this.color = "black"
                this.targetX = this.x;
                this.targetY = this.y;
                
    
                this.drawMainCharacter = function() {
                    if(this.x < this.targetX) {
                        this.x += 10;
                    }
                    if(this.x > this.targetX) {
                        this.x -= 10;
                    }
                    if(this.y < this.targetY) {
                        this.y += 10;
                    }
                    if(this.y > this.targetY) {
                        this.y -= 10;
                    }

                    game.ctx.beginPath();
                    game.ctx.fillStyle = "rgb(0, 0, 0)";;
                    game.ctx.fillRect(this.x, this.y, this.width, this.height);
                    game.ctx.closePath();
                }
                let drawMC = this.drawMainCharacter.bind(this);

                this.draw = function() {
                    drawMC();
                }
    
                this.right = function() {
                    if(this.targetX + this.width < game.width) {
                        this.targetX += 50;
                    }
                }
    
                this.left = function() {
                    if(this.targetX > 0) {
                        this.targetX += -50;
                    }
                }
    
                this.down = function() {
                    if(this.targetY + this.height < game.height) {
                        this.targetY += 50;
                    }
                }
    
                this.up = function() {
                    if(this.targetY > 0) {
                        this.targetY += -50;
                    }
                }
            }
    
            function Game() {
                this.canvas = document.getElementById("div_canvas");
                this.ctx = this.canvas.getContext("2d");
                this.height = this.canvas.height;
                this.width = this.canvas.width;
                this.play = true;
                this.easy_complexity = true;
                                
                this.removeBlock = function(items, i){
                    items.splice(i, 1);
                }
    
                this.animation = function() {
                    if(this.play) {
                        this.ctx.fillStyle = "rgb(255, 255, 255)";
                        this.ctx.fillRect(0, 0, game.width, game.height);
                        mainCharacter.draw.call(mainCharacter);
                        for(let i = 0; i < blocks.length; i++) { 
                            if(blocks[i].y == mainCharacter.y) {
                                if(blocks[i].x < mainCharacter.x + mainCharacter.width && blocks[i].x + blocks[i].width > mainCharacter.x) {
                                    this.play = false;
                                }
                            }
                            blocks[i].draw.call(blocks[i]);
                        }
                        score++;
                        score_value.innerHTML = "ðŸ’¯ " + score;

                        dificulty += 0.001;
                        dificulty_value.innerHTML = "âš¡ x" + Math.round(dificulty * 100) / 100;
                    } else {
                        score_value.innerHTML = "ðŸ’¥ " + score; 
                                
                        this.ctx.fillStyle = "rgb(184, 63, 72)";
                        this.ctx.fillRect(0, 0, this.width, this.height);
                    }
                }
                
                this.startGame = function() {
                    let animationGame = game.animation.bind(game);
                    function addedBlock() {
                        let random = 50 * getRandomInt(1, 6);
                        blocks.push(new Block(this.width, random, 100, 50, mainCharacter.y));
                    }

                    function callAnimationGame() {
                        if(!this.play) clearInterval(timeAnimation);
                        animationGame();
                    }
                    let timeId = setInterval(addedBlock.bind(this), 5000);

                    let timeAnimation = setInterval(callAnimationGame.bind(this), 10);
                }
            }   
    
            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min)) + min;
            }

            function restart() {
                location.reload();
            } 

            function changeTypeDifficulty() {
                if(game.easy_complexity) {
                    game.easy_complexity = false;
                    document.getElementById('complexity_value').innerHTML = "ðŸ˜¡ Hard";
                } else {
                    game.easy_complexity = true;
                    document.getElementById('complexity_value').innerHTML = "ðŸ’š Easy";
                }
                socket.emit('request-message', { message: "back-complexity", value: game.easy_complexity });
            }

            window.onload = () => {
                let random = 50 * getRandomInt(1, 6);
                blocks.push(new Block(game.width, random, 100, 50, mainCharacter.y));

                game.startGame();
            }
            
        </script>
    </body>
</html>
