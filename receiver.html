<!DOCTYPE html>
<html lang="en"></html>
<html> 
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Receiver</title>
        <script src="/socket.io/socket.io.js"></script>
        <style>
            div {
                width: 800px;
                margin: 50px auto;
            }

            #div_canvas {
                border: 5px solid black;
            }

            span {
                font-weight: bold;
                font-family: Helvetica;
                font-size: 32px;
            }

            #dificulty_value {
                float: right;
            }
        </style>
    </head>
    <body> 
        <div>
            <span id="score_value"></span>
            <span id="dificulty_value"></span>
            <canvas id="div_canvas" width="800" height="300"></canvas>
        </div>
        <script>
            var canvas = document.getElementById("div_canvas");
            var ctx = canvas.getContext("2d");
            var height = canvas.height;
            var width = canvas.width;
            var position = Math.floor(height / 2);
            var block = [];
            var game = true;
            var score = 0;
            var score_value = document.getElementById("score_value");
            var dificulty_value = document.getElementById("dificulty_value");
            var dificulty = 1;

            var background = new Image();
            background.src = "https://raw.githubusercontent.com/Beelink/tetrisrace/master/img/background.png";
            var backgroundPattern = ctx.createPattern(background, 'repeat');

            var foreground = new Image();
            foreground.src = "https://raw.githubusercontent.com/Beelink/tetrisrace/master/img/foreground.png";
            var foregroundPattern = ctx.createPattern(foreground, 'repeat');
            
            var mainCharacter = new MainCharacter();
    
            var socket = io.connect('http://localhost:8080/');
    
            socket.on('Done', function (data) {
                switch(data['Name']) {
                case "left": mainCharacter.left();
                    break;
                case "right": mainCharacter.right();
                    break;
                case "up": mainCharacter.up();
                    break;
                case "down": mainCharacter.down();
                    break;
                case "restart": restart();
                    break;
                }
            });
    
            function Block(x, y, width, height) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = "black"
                let selfBlock = this;
    
                this.drawBlock = function() {
                    ctx.beginPath();
                    ctx.fillStyle = foregroundPattern;
                    ctx.fillRect(selfBlock.x, selfBlock.y, selfBlock.width, selfBlock.height);
                    ctx.closePath();
                }
    
                this.draw = function() {
                    selfBlock.drawBlock();
                    selfBlock.x -= dificulty;

                    if(selfBlock.x < - selfBlock.width) {
                        for(let i = 0; i < block.length; i++) {
                            if(block[i] == selfBlock) {
                                block.splice(i, 1);
                            }
                        }
                    }
                }
            }
    
            function MainCharacter() {
                this.x = 0;
                this.y = Math.floor(height / 2);
                this.width = 100;
                this.height = 50;
                this.color = "black"
                let self = this;
                this.targetX = self.x;
                this.targetY = self.y;
    
                this.drawMainCharacter = function() {
                    if(self.x < self.targetX) {
                        self.x += 10;
                    }
                    if(self.x > self.targetX) {
                        self.x -= 10;
                    }
                    if(self.y < self.targetY) {
                        self.y += 10;
                    }
                    if(self.y > self.targetY) {
                        self.y -= 10;
                    }

                    ctx.beginPath();
                    ctx.fillStyle = foregroundPattern;
                    ctx.fillRect(self.x, self.y, self.width, self.height);
                    ctx.closePath();
                }
    
                this.draw = function() {
                    self.drawMainCharacter();
                }
    
                this.right = function() {
                    if(self.targetX + self.width < width) {
                        self.targetX += 50;
                    }
                }
    
                this.left = function() {
                    if(self.targetX > 0) {
                        self.targetX += -50;
                    }
                }
    
                this.down = function() {
                    if(self.targetY + self.height < height) {
                        self.targetY += 50;
                    }
                }
    
                this.up = function() {
                    if(self.targetY > 0) {
                        self.targetY += -50;
                    }
                }
            }
    
            function animation() {
                if(game) {
                    ctx.fillStyle = backgroundPattern;
                    ctx.fillRect(0, 0, width, height);
                    mainCharacter.draw();
                    for(let i = 0; i < block.length; i++) { 
                        if(block[i].y == mainCharacter.y) {
                            if(block[i].x < mainCharacter.x + mainCharacter.width && block[i].x + block[i].width > mainCharacter.x) {
                                game = false;
                            }
                        }
                        block[i].draw();
                    }
                    score++;
                    score_value.innerHTML = "Score: " + score;

                    dificulty += 0.001;
                    dificulty_value.innerHTML = "Speed: x" + Math.round(dificulty * 100) / 100;
                } else {
                    score_value.innerHTML = "Crash! Total: " + score; 
                            
                    ctx.fillStyle = foregroundPattern;
                    ctx.fillRect(0, 0, width, height);
                }
            }
    
            function animationShowBlock() {
                let timeId = setInterval(function() {
                    if(!game) clearInterval(timeId);

                    let random = 50 * getRandomInt(1, 6);
                    block.push(new Block(width, random, 100, 50));
                }, 1000);

                let timeAnimation = setInterval(function() {
                    if(!game) clearInterval(timeAnimation);
                    animation();
                }, 10);
            }
    
            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min)) + min;
            }
    
            function restart() {
                location.reload();
            }   
    
            window.onload = () => {
                animationShowBlock();
            }
        </script>
    </body>
</html>
